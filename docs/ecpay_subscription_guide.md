# 綠界 (ECPay) 訂閱與定期定額設定指南

## 核心觀念：為什麼不需要在綠界後台設定「方案」？

在您目前的系統架構（SaaS Platform）中，我們採用的是最靈活的 **「信用卡綁定 (Tokenization)」** 模式，而不是傳統的「定期定額 (Recurring)」表單。

### 差異比較

| 特性 | 您的系統 (API 綁定模式) | 傳統綠界定期定額 |
| :--- | :--- | :--- |
| **扣款邏輯位置** | **您的資料庫與程式碼 (我們控制)** | 綠界系統 (他們控制) |
| **彈性** | **極高** (可隨時換方案、退款、依使用量計費) | 低 (固定金額、固定週期) |
| **方案設定** | **在您的 Admin 後台設定** | 需登入綠界後台設定 |
| **使用者體驗** | **無縫** (站內直接升級、無需跳轉多次) | 需跳轉至綠界簽署合約 |

### 您需要做的後台設定

因為邏輯掌握在我們手中，**您「不需要」在綠界後台設定任何月費方案 ($299, $599 等)**。

您只需要確保：
1.  **商店權限**：您的綠界帳號已開通 **「信用卡授權 (Credit Card)」** 與 **「信用卡定期定額/記憶卡號」** 權限。（測試環境預設已開通）
2.  **查詢交易**：您未來的對帳，是到綠界後台的 **「信用卡授權查詢」** 中查看每一筆由我們系統自動發起的扣款紀錄。

---

## 系統自動化流程

1.  **綁定 (Binding)**：
    用戶點擊方案 -> 系統引導至綠界輸入卡號 -> 綠界回傳 Token (Card ID) -> 我們存入資料庫。
    *(這就是目前我們剛修好的部分)*

2.  **首扣 (First Charge)**：
    綁定成功當下，系統利用 Token 發動第一筆扣款 (例如 $299)，並開通權限。

3.  **續扣 (Recurring - Cron Job)**：
    系統排程 (Cron Job) 每天檢查資料庫 -> 發現某商家合約到期 -> 自動執行續約邏輯。
    
    > **⚠️ 重要提示：關於全自動扣款**
    > 若要實現「完全不需用戶介入」的背景扣款（Server-to-Server Charge），您必須向綠界申請開通 **「站內付 2.0 (非 3D 交易)」** 權限。
    > 目前的 Cron Job 會自動產生帳單紀錄並延長合約日期 (模擬扣款成功)。一旦開通該權限，只需將 `console.log` 替換為實際的 API 呼叫即可。

### Cron Job 設定
請在您的 Zeabur 或任何 Cron 服務中設定：
- **URL**: `https://your-domain.com/api/cron/billing`
- **Method**: `GET`
- **Header**: `Authorization: Bearer <您的 CRON_SECRET>`

---

## 綠界廠商後台設定步驟

若您需要查詢商店代號、金鑰或申請權限，請依照以下步驟操作：

### 1. 取得商店代號 (MerchantID) 與介接金鑰 (HashKey / HashIV)
這是我們串接 API 最重要的資訊，請務必妥善保管。

1.  登入 [綠界廠商管理後台](https://vendor.ecpay.com.tw/)。
2.  左側選單點擊 **「系統開發管理」** > **「系統介接設定」**。
3.  您會看到您的 **商店代號 (MerchantID)**。
4.  點擊 **「查詢/設定」** 按鈕，通過手機驗證後，即可看到 **HashKey** 與 **HashIV**。
5.  將這些資訊填入您的專案 `.env.local` 檔案中：
    ```bash
    ECPAY_MERCHANT_ID=XXXXXX
    ECPAY_HASH_KEY=XXXXXX
    ECPAY_HASH_IV=XXXXXX
    ```

### 2. 確認信用卡與綁定權限
確保您的帳號可以執行我們開發的功能。

1.  登入 [綠界廠商管理後台](https://vendor.ecpay.com.tw/)。
2.  左側選單點擊 **「信用卡收單」** > **「信用卡授權資訊」** (或類似的權限管理區域)。
3.  確認您已開通以下服務：
    -   **信用卡一次付清 (Credit Card)**
    -   **信用卡定期定額 / 記憶卡號 (Binding / Token)**
    *   *註：若未開通，請聯繫綠界客服申請。*

### 3. 申請「站內付 2.0 (非 3D 交易)」(進階)
若您希望 Cron Job 能在背景全自動扣款（不需用戶輸入驗證碼），您需要此權限。

1.  聯繫綠界業務或客服。
2.  告知您需要使用 **「站內付 2.0 API (Server-to-Server 自動扣款)」** 功能。
3.  通常銀行會審核您的退刷率與風險，通過後即可開通。
4.  開通後，我們會將 Cron Job 中的模擬扣款代碼替換為真實 API 呼叫。

### 4. 查詢交易紀錄 (對帳)
所有透過我們平台發起的「綁定」與「扣款」，都可以在綠界後台查到。

1.  左側選單點擊 **「信用卡收單」** > **「交易明細查詢」**。
2.  您可以看到這裡有我們產生的訂單編號 (例如 `BIND...` 或 `SIM...`)。
3.  若交易狀態為「授權成功」，代表扣款成功。
